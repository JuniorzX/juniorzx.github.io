<!DOCTYPE html>
<html>
  <head>
      <title>Missive</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,user-scalable=no,viewport-fit=cover">
      <meta http-equiv="Accept-CH" content="DPR, Width">
      <meta name="description" content="Email, group chat and tasks for productive teams. One app for all your internal and external communication. Work management at its best. Try it free!">
      <meta name="apple-mobile-web-app-title" content="Missive">
      <meta name="apple-itunes-app" content="app-id=1231206084">
      <meta name="google" content="notranslate">
      <link rel="apple-touch-icon" type="image/x-icon" href="https://dx9t285h889zc.cloudfront.net/dist/images/missive-apple-touch-icon-d5d0cb3a4417ed837614da93b78ab15c.png">
      <link rel="mask-icon" href="https://dx9t285h889zc.cloudfront.net/dist/images/missive-icon-f93a53ffb5e67fb2d74f20e7f71d5bd2.svg" color="#222427">
      <link rel="manifest" href="/manifest.json">
      <script async src="https://dx9t285h889zc.cloudfront.net/dist/preboot-6f15f25ebaea1dbab510.js" integrity="sha512-wsr+/GXcNONfMr6Z+T1J/K3iTxAU4wJAOOdlD4nRWM1/TQofz9pMTUMoayc8tHiACcyUU+v9xFAmSU4Mhsl9TQ==" crossorigin="anonymous"></scriptpony>
      <link rel="stylesheet" href="https://dx9t285h889zc.cloudfront.net/dist/libraries-401dd1f41aa163d3e6d3.css" integrity="sha512-4TQijZr3Z5vHdFXDgVn7eGrsrMForJCmWE+NYgIJyE95AxfBM0mnjzTkxcldlu6ckNywHIiIHbE2GfF1CPS4qw==" crossorigin="anonymous">
      <link rel="stylesheet" href="https://dx9t285h889zc.cloudfront.net/dist/application-1c1cca38f63c8ef8aa00.css" integrity="sha512-AfIm90uUNgvQqILsjDt1+vVIzQgF1MEot9KaqhvJNvgQ7Vfu4hDFkROd/lgLV/igPSRKSBzmMytb6LXFPGRWvA==" crossorigin="anonymous">
      <link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <script src="https://integrations.missiveapp.com/missive.js"></script>
      <style>
        #ThreeBoxItemSearchResult {
          border: 1px dotted #ccc;
          padding: 3px;
          height: 10rem;
          overflow: auto;
          white-space: nowrap;
          display: none;
        }
        #ThreeBoxItemSearchResult ul {
          list-style-type: none;
          padding: 0;
          margin: 0;
        }
        #ThreeBoxItemSearchResult ul li {
          padding: 5px 0;
        }
        #ThreeBoxItemSearchResult ul li:hover {
          background: #eee;
        }
        .attribute {
          display: flex;
          flex: 0 0 auto;
          width: 95%;
          height: 100%;
          align-items: flex-start;
          justify-content: flex-start;
          margin: 5px;
        }
        .attributeInput {
          flex: 1;
          height: 100%;
          color: black;
          max-width: 10em;
        }
        .attributeSelect {
          flex: 1;
          height: 100%;
          color: black;
          width: inherit;
        }
        .attributeLabel {
          margin-right: 5px;
        }
        .checkboxx {
          -webkit-appearance: checkbox;
          -moz-appearance: checkbox;
          appearance: checkbox;
        }
        .historyButton {
          padding: 5px;
          margin-top: 5px;
          background-color: #7c4c08;
          color: white;
          text-align: center;
        }
        .historyPerCustomer {
          padding: 5px;
        }
        .so-item, .po-item {
          display: inline-block;
          padding: 5px 10px;
          margin: 2px;
          cursor: pointer;
          border-radius: 4px;
          font-size: 0.9em;
        }
        .so-item {
          background-color: rgba(0, 158, 97, 0.1);
          border: 1px solid rgba(0, 158, 97, 0.15);
          color: rgba(0, 158, 97, 0.85);
        }
        .po-item {
          background-color: rgba(204, 0, 0, 0.1);
          border: 1px solid rgba(204, 0, 0, 0.15);
          color: rgba(204, 0, 0, 0.85);
        }
        .so-item:hover, .po-item:hover {
          opacity: 0.8;
        }
      </style>
  </head>
  <body>
    <div id="PADDINGBLOCK" class="padding-block" style="user-select: text;">
      <div id="OneBoxSubject" class="missive ellipsis text-600 padding-xsmall">B330744 GROUPTEK- Pick-Up request [P1515G BVI] Return of goods) (Status-Reminder)TOP URGENT</div>
      <div id="TwoBoxSOPO" class="missive padding-xsmall text-600 missive-columns missive-flex-basis-auto" style="min-width: 2.1em;background-color: var(--background-color)">
        <span id="SOButton" class="label-token no-wrap missive-columns-middle missive-columns-center" style="user-select: text;">
          <span id="SONumber" class="padding-small no-wrap">SO:- - </span>
        </span>
        <span id="POButton" class="label-token no-wrap missive-columns-middle missive-columns-center" style="user-select: text;">
          <span id="PONumber" class="padding-small no-wrap">PO:- - </span>
        </span>
      </div>
      <div id="ThreeBoxItemSearch" class="columns-vertical margin-xsmall">
        <div class="columns">
          <div class="missive column-grow columns">
            <input id="ThreeBoxItemSearchBox" placeholder="Search Item" autocorrect="off" autocomplete="off" class="input column-grow margin-xsmall ellipsis margin-right-xsmall" type="search" name="itemName" onkeyup="DEAR_getItemsList(this.value)" onfocus="DEAR_getItemsList(this.value)" onblur="hideThreeBoxItemSearchResult()">
          </div>
          <div id="ThreeBoxItemFindButton" class="button ellipsis">Find</div>
        </div>  
        <div id="ThreeBoxItemSearchResult" class="column"></div>
      </div>
      <div class="missive-columns-vertical" style="height: 85vh;overflow: auto; user-select: text;">
        <div id="FourUserData" class="columns-vertical margin-xsmall"></div>
      </div> 
    </div>
    <script>
      // Optomize for V2.1 then Deep Optomize for V2.2, Add tools in V3.0 then Loop || V3.1>V3.2>V4.0>V4.1>V4.2>V5.0............
      // Globals
      let SCRIPT_VERSION = "Integration V2.0";
      let FIRST = "";
      let SECOND = "";
      let THIRD = "";
      let SALE_RAW_URL = "https://inventory.dearsystems.com/Sale#";
      let PURCHASE_RAW_URL = "https://inventory.dearsystems.com/Purchase#";
      let PURCHASE_ATTRIBUTES_LIST = "";
      let SALE_ATTRIBUTES_LIST = "";
      // Resets
      function resetSONumber() { document.getElementById("SONumber").innerHTML = "SO:- "; }
      function resetPONumber() { document.getElementById("PONumber").innerHTML = "PO:- "; }
      function resetSubject() { document.getElementById("OneBoxSubject").innerHTML = SCRIPT_VERSION; }
      function resetFields() { resetSONumber(); resetPONumber(); resetSubject(); }
      // Auto SO/PO Helpers
      function findSO(subj) {
        let pattern = /[S]\d\d*[G]/gi;
        let result = subj.match(pattern);
        if (result == null) {
          resetSONumber();
          return;
        }
        let html = result.map(so => `<span class="so-item" onclick="DEAR_searchSale('${so}')">${so}</span>`).join(' ');
        document.getElementById("SONumber").innerHTML = html;
      }
      function findPO(subj) {
        let pattern = /[P]\d\d*[G]/gi;
        let result = subj.match(pattern);
        if (result == null) {
          resetPONumber();
          return;
        }
        let html = result.map(po => `<span class="po-item" onclick="DEAR_searchPurchase('${po}')">${po}</span>`).join(' ');
        document.getElementById("PONumber").innerHTML = html;
      }
      function autoFindSOPO(convo) {
        let subject = convo.subject;
        findSO(subject);
        findPO(subject);
      }
      // Result Box Controller
      function showThreeBoxItemSearchResult() { document.getElementById("ThreeBoxItemSearchResult").style.display = "block"; }
      function hideThreeBoxItemSearchResult() { document.getElementById("ThreeBoxItemSearchResult").style.display = "none"; }
      function searchingThreeBoxItemSearchResult(what) { document.getElementById("ThreeBoxItemSearchResult").innerHTML = "Searching... " + what; }
      function setThreeBoxItemSearchResult(toSet) { document.getElementById("ThreeBoxItemSearchResult").innerHTML = toSet; }
      function itemThis(th) { hideThreeBoxItemSearchResult(); document.getElementById("ThreeBoxItemSearchBox").value = th.innerHTML; }
      function closeThis(th) { th.parentElement.parentElement.style.display = 'none'; }
      function popProduct(e) {
        let {title: t, message: s, note: n} = e;
        t || (t = "Oops, something went wrong!");
        s || (s = "");
        n || (n = "You may want to try again later or refresh the integration.");
        let i = document.createElement("div");
        i.className = "alert columns-middle columns-center";
        let r = "";
        t && (r += `<div class="row text-large">${t}</div>`);
        s && (r += `<div class="row text-c">${s}</div>`);
        n && (r += `<div class="row text-c text-small">${n}</div>`);
        i.innerHTML = `\n      <div class="alert-box align-center">\n        <div class="padding-large">\n          ${r}\n        </div>\n        <div class="alert-buttons columns">\n          <span class="alert-button column-grow padding" onClick="Missive.reload()">Refresh</span>\n          <span class="alert-button alert-button--active column-grow padding" onClick="this.parentElement.parentElement.parentElement.remove()">Got it</span>\n        </div>\n      </div>\n    `;
        document.body.appendChild(i);
      }
      function popDataPurchaseAttachments(e) {
        let i = document.createElement("div");
        i.className = "alert columns-middle columns-center";
        i.style = "display: flex;align-items: flex-start;overflow: scroll;margin: 1em;";
        i.innerHTML = `\n      <div style="margin: 1em;" class="alert-box align-center">\n        <div class="padding-large">\n          ${e.getAttribute("data-purchase-attachments")}\n        </div>\n        <div class="alert-buttons columns">\n    <span class="alert-button alert-button--active column-grow padding" onClick="this.parentElement.parentElement.parentElement.remove()">Got it</span>\n        </div>\n      </div>\n    `;
        document.body.appendChild(i);
      }
      function popDataSaleAttachments(e) {
        let i = document.createElement("div");
        i.className = "alert columns-middle columns-center";
        i.style = "display: flex;align-items: flex-start;overflow: scroll;margin: 1em;";
        i.innerHTML = `\n      <div style="margin: 1em;" class="alert-box align-center">\n        <div class="padding-large">\n          ${e.getAttribute("data-sale-attachments")}\n        </div>\n        <div class="alert-buttons columns">\n    <span class="alert-button alert-button--active column-grow padding" onClick="this.parentElement.parentElement.parentElement.remove()">Got it</span>\n        </div>\n      </div>\n    `;
        document.body.appendChild(i);
      }
      // Purchase Attributes
      function popPurchaseAttributes(e) {
        const randID = Math.random().toString(16).substr(2, 8);
        let i = document.createElement("div");
        i.className = "alert columns-middle columns-center";
        let r = "Getting Purchase Attributes...";
        i.innerHTML = `\n      <div class="alert-box align-center">\n        <div id=${randID} class="padding-large">\n          ${r}\n        </div>\n        <div class="alert-buttons columns">\n          <span class="alert-button column-grow padding" onClick="this.parentElement.parentElement.parentElement.remove()">Cancel</span>\n          <span class="alert-button alert-button--active column-grow padding" onClick="putPurchaseAttributeHelper('${e.getAttribute("data-purchase-id")}','${randID}')">Save</span>\n        </div>\n      </div>\n    `;
        document.body.appendChild(i);
        if (e.getAttribute("data-purchase-type") == "Advanced Purchase") {
          DEAR_getAdvancedPurchaseAttributes(randID, e.getAttribute("data-purchase-id"));
        } else {
          DEAR_getPurchaseAttributes(randID, e.getAttribute("data-purchase-id"));
        }
        console.log(e.getAttribute("data-purchase-id"));
      }
      function popPurchaseAttributesExtra(eleID, pr) {
        let allAttributes = "";
        for (let i = 0; i < PURCHASE_ATTRIBUTES_LIST.length; i++) {
          let input_id = pr.ID + "_" + ("AdditionalAttribute" + (i+1));
          allAttributes += `<div class="attribute"><label class="ellipsis attributeLabel">${PURCHASE_ATTRIBUTES_LIST[i].Name} </label>`;
          if (PURCHASE_ATTRIBUTES_LIST[i].Type == "Text") {
            if (pr.AdditionalAttributes[("AdditionalAttribute" + (i+1))] == null) {
              allAttributes += `<input type="text" value='' id='${input_id}' class="attributeInput input"/>`;
            } else {
              allAttributes += `<input type="text" value='${pr.AdditionalAttributes[("AdditionalAttribute" + (i+1))]}' id='${input_id}' class="attributeInput input"/>`;
            }
          } else if (PURCHASE_ATTRIBUTES_LIST[i].Type == "List") {
            allAttributes += `<select id='${input_id}' class="attributeSelect" name='${PURCHASE_ATTRIBUTES_LIST[i].Name}'>`;
            const myArray = PURCHASE_ATTRIBUTES_LIST[i].Values.split(",");
            let currentValue = pr.AdditionalAttributes[("AdditionalAttribute" + (i+1))];
            myArray.push("");
            if (currentValue == null) {
              currentValue = "";
            }
            let found = false;
            for (let i = 0; i < myArray.length; i++) {
              if (myArray[i] == currentValue) {
                allAttributes += `<option selected value='${myArray[i]}'>${myArray[i]}</option>`;
                found = true;
              } else {
                allAttributes += `<option value='${myArray[i]}'>${myArray[i]}</option>`;
              }
            }
            if (!found) {
              allAttributes += `<option selected value='${currentValue}'>${currentValue}</option>`;
            }
            allAttributes += `</select>`;
          } else if (PURCHASE_ATTRIBUTES_LIST[i].Type == "Checkbox") {
            if (pr.AdditionalAttributes[("AdditionalAttribute" + (i+1))] == "true") {
              allAttributes += `<input checked type="checkbox" id='${input_id}' class="attributeInput input">`;
            } else {
              allAttributes += `<input type="checkbox" id='${input_id}' class="attributeInput input">`;
            }
          }
          allAttributes += `</div>`;
        }
        document.getElementById(eleID).innerHTML = allAttributes;
      }
      function putPurchaseAttributeHelper(purchase_id, eleID) {
        document.getElementById(eleID).style.backgroundColor = 'red';
        let purchase_body = {"ID": purchase_id, "AdditionalAttributes": {}};
        for (let i = 1; i <= 10; i++) {
          let elem = document.getElementById(purchase_id + "_" + ("AdditionalAttribute" + i));
          if (elem.type === "checkbox") {
            purchase_body.AdditionalAttributes[("AdditionalAttribute" + i)] = elem.checked ? "true" : "false";
          } else {
            purchase_body.AdditionalAttributes[("AdditionalAttribute" + i)] = elem.value;
          }
        }
        console.log(purchase_body);
        DEAR_GET2PUTPurchaseAttributes(purchase_body, eleID);
      }
      // Sale Attributes
      function popSaleAttributes(e) {
        const randID = Math.random().toString(16).substr(2, 8);
        let i = document.createElement("div");
        i.className = "alert columns-middle columns-center";
        let r = "Getting Sale Attributes...";
        i.innerHTML = `\n      <div class="alert-box align-center">\n        <div id=${randID} class="padding-large">\n          ${r}\n        </div>\n        <div class="alert-buttons columns">\n          <span class="alert-button column-grow padding" onClick="this.parentElement.parentElement.parentElement.remove()">Cancel</span>\n          <span class="alert-button alert-button--active column-grow padding" onClick="putSaleAttributeHelper('${e.getAttribute("data-sale-id")}','${randID}')">Save</span>\n        </div>\n      </div>\n    `;
        document.body.appendChild(i);
        console.log(e.getAttribute("data-sale-id"));
        DEAR_getSaleAttributes(randID, e.getAttribute("data-sale-id"));
      }
      function popSaleAttributesExtra(eleID, sl) {
        let allAttributes = "";
        for (let i = 0; i < SALE_ATTRIBUTES_LIST.length; i++) {
          let input_id = sl.ID + "_" + ("AdditionalAttribute" + (i+1));
          allAttributes += `<div class="attribute"><label class="ellipsis attributeLabel">${SALE_ATTRIBUTES_LIST[i].Name} </label>`;
          if (SALE_ATTRIBUTES_LIST[i].Type == "Text") {
            if (sl.AdditionalAttributes[("AdditionalAttribute" + (i+1))] == null) {
              allAttributes += `<input type="text" value='' id='${input_id}' class="attributeInput input"/>`;
            } else {
              allAttributes += `<input type="text" value='${sl.AdditionalAttributes[("AdditionalAttribute" + (i+1))]}' id='${input_id}' class="attributeInput input"/>`;
            }
          } else if (SALE_ATTRIBUTES_LIST[i].Type == "List") {
            allAttributes += `<select id='${input_id}' class="attributeSelect" name='${SALE_ATTRIBUTES_LIST[i].Name}'>`;
            const myArray = SALE_ATTRIBUTES_LIST[i].Values.split(",");
            let currentValue = sl.AdditionalAttributes[("AdditionalAttribute" + (i+1))];
            myArray.push("");
            if (currentValue == null) {
              currentValue = "";
            }
            for (let i = 0; i < myArray.length; i++) {
              if (myArray[i] == currentValue) {
                allAttributes += `<option selected value='${myArray[i]}'>${myArray[i]}</option>`;
              } else {
                allAttributes += `<option value='${myArray[i]}'>${myArray[i]}</option>`;
              }
            }
            allAttributes += `</select>`;
          } else if (SALE_ATTRIBUTES_LIST[i].Type == "Checkbox") {
            if (sl.AdditionalAttributes[("AdditionalAttribute" + (i+1))] == "true") {
              allAttributes += `<input checked type="checkbox" id='${input_id}' class="attributeInput input">`;
            } else {
              allAttributes += `<input type="checkbox" id='${input_id}' class="attributeInput input">`;
            }
          }
          allAttributes += `</div>`;
        }
        document.getElementById(eleID).innerHTML = allAttributes;
      }
      function putSaleAttributeHelper(sale_id, eleID) {
        document.getElementById(eleID).style.backgroundColor = 'red';
        let sale_body = {"ID": sale_id, "AdditionalAttributes": {}};
        for (let i = 1; i <= 10; i++) {
          let elem = document.getElementById(sale_id + "_" + ("AdditionalAttribute" + i));
          if (elem.type === "checkbox") {
            sale_body.AdditionalAttributes[("AdditionalAttribute" + i)] = elem.checked ? "true" : "false";
          } else {
            sale_body.AdditionalAttributes[("AdditionalAttribute" + i)] = elem.value;
          }
        }
        console.log(sale_body);
        DEAR_GET2PUTSaleAttributes(sale_body, eleID);
      }
      function showPurchase(pr, elementID) {
        console.log(pr);
        if (pr.Type == "Advanced Purchase") {
          var toAppend = `<div style="background-color: #a5313145;align-items: center;display: flex;justify-content: space-around;"><b>${pr.Type} ${pr.OrderNumber} (${pr.Status})</b></div><div class="columns"><div class="column column-grow" style="flex-shrink: 1;">${pr.Supplier}</div><span onclick="closeThis(this)" class="close">×</span></div><div class="column">Order: ${pr.Order.Status}</div><div class="column">Total: ${pr.Order.Total} ${pr.SupplierCurrency}</div>`;
        } else {
          var toAppend = `<div style="background-color: #a5313145;align-items: center;display: flex;justify-content: space-around;"><b>${pr.OrderNumber} (${pr.Status})</b></div><div class="columns"><div class="column column-grow" style="flex-shrink: 1;">${pr.Supplier}</div><span onclick="closeThis(this)" class="close">×</span></div><div class="column">Order: ${pr.Order.Status}</div><div class="column">Total: ${pr.Order.Total} ${pr.SupplierCurrency}</div>`;
        }
        let toAttach = "<ul style=\"padding-inline-start: 20px;\">";
        if (pr.Attachments.length > 0) {
          for (let i = 0; i < pr.Attachments.length; i++) {
            let decoded = decodeURI(pr.Attachments[i].FileName);
            toAttach += `<a href="${pr.Attachments[i].DownloadUrl}" target="_blank"><li style="margin-bottom:1em;">${decoded}</li></a>`;
          }
        }
        toAttach += "</ul>";
        let attachments = `<div onclick="popDataPurchaseAttachments(this)" data-purchase-attachments='${toAttach}' class="button" style="overflow-wrap: anywhere;background-color: #795548;align-items: center;display: flex;justify-content: space-around;flex-grow: 1;margin: 1px;"><b>Attachments ${pr.Attachments.length}</b></div>`;
        let attributes = `<div onclick="setPurchaseAtributes();popPurchaseAttributes(this)" data-purchase-type="${pr.Type}" data-purchase-id=${pr.ID} data-purchase-supID=${pr.SupplierID} class="button" style="background-color: #009688;align-items: center;display: flex;justify-content: space-around;flex-grow: 1;margin: 1px;"><b>Attributes</b></div>`;
        let divdiv = '<div class="columns" style="display: flex;">' + attachments + attributes + '</div>';
        document.getElementById(elementID).innerHTML = toAppend + divdiv;
      }
      function showSale(sl, elementID) {
        console.log(sl);
        let tempInvoices = "";
        for (let i = 0; i < sl.Invoices.length; i++) {
          tempInvoices += `<div class="column"><b>Invoice#${sl.Invoices[i].InvoiceNumber} ${sl.Invoices[i].Status}</b><br><b>Amount:</b> ${sl.Invoices[i].Total}${sl.BaseCurrency}<br><b>Paid:</b> ${sl.Invoices[i].Paid}${sl.CustomerCurrency}</div>`;
        }
        let toAppend = `<div style="background-color: #1a702324;align-items: center;display: flex;justify-content: space-around;"><b>${sl.OrderbezierPaths.strokeColor = '#000000';
ctx.stroke();
ctx.closePath();
ctx.restore();
</script>
</body>
</html>
